name: Staple Notarized DMG

# Run manually after a v* tag build completes and notarization succeeds

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of the v* tag build (from URL: /actions/runs/[RUN_ID])'
        required: true
        type: string

permissions:
  contents: write
  actions: read

jobs:
  staple:
    runs-on: macos-14
    steps:
      - name: Download DMG artifact
        uses: actions/download-artifact@v4
        with:
          name: nailed-${{ inputs.run_id }}
          path: build
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download submission ID
        uses: actions/download-artifact@v4
        with:
          name: notarization-${{ inputs.run_id }}
          path: build
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check notarization status and staple
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_KEY_ISSUER: ${{ secrets.APPLE_API_KEY_ISSUER }}
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
        run: |
          # Create API key file
          mkdir -p ~/private_keys
          echo "$APPLE_API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8
          
          SUBMISSION_ID=$(cat build/submission-id.txt)
          echo "Checking status for submission: $SUBMISSION_ID"
          
          # Check notarization status
          xcrun notarytool info "$SUBMISSION_ID" \
            --key ~/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_KEY_ISSUER"
          
          # Wait if still in progress (with timeout)
          xcrun notarytool wait "$SUBMISSION_ID" \
            --key ~/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_KEY_ISSUER" \
            --timeout 10m
          
          # Staple the ticket
          xcrun stapler staple build/nailed.dmg
          
          # Verify
          xcrun stapler validate build/nailed.dmg
          
          # Cleanup
          rm -rf ~/private_keys

      - name: Upload stapled DMG
        uses: actions/upload-artifact@v4
        with:
          name: nailed-${{ inputs.run_id }}-stapled
          path: build/nailed.dmg

      - name: Get tag from original run
        id: get-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh api /repos/${{ github.repository }}/actions/runs/${{ inputs.run_id }} --jq '.head_branch')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Tag from original run: $TAG"

      - name: Create/update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get-tag.outputs.tag }}
          files: build/nailed.dmg
          fail_on_unmatched_files: true

